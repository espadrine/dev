<!doctype html>
<title>Our Awesome Code Editor</title>
<meta charset=utf-8>

<style>
  html body { margin: 0px; padding: 0px; width: 100%; height: 100%; position: absolute; }
  iframe body { margin: 0px; padding: 0px; }
  iframe { height: 100%; width: 49%; border: none; }
  .right { float: right; }
</style>

<body>

  <iframe id=preview class=right></iframe>
  
  <script src=js/sclib.js></script>
  <script src=js/codemirror.js></script>
  <script src=js/diff_match_patch.js></script>
  <script src=js/diff.js></script>
  <script src=js/client.js></script>
  
  <script>
  
    client = {
      user: "dom",
      rev: 0,
      copy: "<!doctype html>\n<title><\/title>\n\n<body>\n  <canvas id=tutorial width=150 height=150><\/canvas>\n\n  <script>\n    var canvas = document.getElementById('tutorial');\n    var context = canvas.getContext('2d');\n\n    context.fillStyle = 'rgb(250,0,0)';\n    context.fillRect(10, 10, 55, 50);\n\n    context.fillStyle = 'rgba(0, 0, 250, 0.5)';\n    context.fillRect(30, 30, 55, 50);\n  <\/script>\n<\/body>",
      timeout: 500
    }
	
    var editor = new CodeMirror(document.body, {
      content: window.client.copy,
      height: "100%",
      width: "50%",
      parserfile: ["parsexml.js", "parsecss.js", "tokenizejavascript.js", "parsejavascript.js", "parsehtmlmixed.js"],
      stylesheet: ["css/xmlcolors.css", "css/jscolors.css", "css/csscolors.css"],
      path: "js/"
    });

    /*setInterval(Scout.send(function(xhr, params){
	
      var dmp = new diff_match_patch();
      var bufcopy = editor.editor.getCode();
	
      params.data = {
        usr: client.usr,
        rev: client.rev,
        delta: Diff.delta(dmp.diff_main(client.copy, editor.editor.getCode()))
      };
	  
	  params.error = function(xhr, status) {
	    // TODO
	  };
	  
      params.open.url = '/_/change';
	  
      params.resp = function(xhr, resp) {
		client.rev = resp.rev;
		client.delta = [];
		var pos = editor.editor.cursorPosition(true);
		var text = editor.editor.getCode();
		
		var dmp = new diff_match_patch();
        client.delta = Diff.solve(Diff.delta(dmp.diff_main(bufcopy, text)), resp.delta);
        text = Diff.applydelta(resp.delta, text);
        client.copy = text;
        editor.editor.setCode(Diff.applydelta(delta, text));
		
		// this doesn't actually select lines, it places the cursor to the old position
		editor.editor.selectLines(pos.line, pos.character);
      };
	  
    }), client.timeout);*/
  
    setInterval((function() {
	  preview = document.getElementById('preview');
	  return function() { preview.contentDocument.open(); preview.contentDocument.write(editor.editor.getCode()); preview.contentDocument.close(); }
	})(), 500);
	
  </script>
  
</body>
